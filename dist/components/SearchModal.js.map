{"version":3,"sources":["../../src/components/SearchModal.tsx"],"sourcesContent":["'use client'\n\nimport { Dialog, Transition } from '@headlessui/react'\nimport cn from 'classnames'\nimport { debounce, get } from 'lodash'\nimport Link from 'next/link'\nimport { useRouter } from 'next/navigation'\nimport { ChangeEvent, Fragment, useCallback, useLayoutEffect, useRef, useState } from 'react'\nimport { AiOutlineLoading3Quarters } from 'react-icons/ai'\nimport { BsArrowReturnLeft } from 'react-icons/bs'\nimport { FiSearch } from 'react-icons/fi'\nimport { IoBookOutline, IoCloseCircle, IoDocumentTextOutline } from 'react-icons/io5'\nimport useSWR from 'swr'\n\nimport { SearchResult } from '../interface'\n\ntype SearchModalProps = {\n  url: string // Cannot use process.env because it will be undefined in the client side\n  isOpen: boolean\n  closeModal: () => void\n  slugPrefix?: string\n  className?: string\n  errorMessage?: string\n  noResultsMessage?: string\n  foundResultsMessage?: string // should be in the format of 'Found {{count}} results'\n  placeholder?: string\n}\n\nexport default function SearchModal(props: SearchModalProps) {\n  const inputRef = useRef<HTMLInputElement>(null)\n  const containerRef = useRef<HTMLDivElement>(null)\n  const [query, setQuery] = useState('')\n  const [queryToSearch, setQueryToSearch] = useState(query)\n  const [selected, setSelected] = useState(-1)\n  const router = useRouter()\n\n  const {\n    data: fullData,\n    error,\n    isLoading\n  } = useSWR<SearchResult[]>([props.url, { query: queryToSearch }], ([url, params]: any) =>\n    fetcher(url, params)\n  )\n  const data = fullData ? fullData.filter(rs => rs.isPublished) : fullData\n\n  if (error) console.log('🐞 Error in search modal: ', error)\n\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  const debounceSearch = useCallback(\n    debounce(value => triggerSearch(value), 1000),\n    [queryToSearch]\n  )\n\n  function handleOnchangeInput(e: ChangeEvent<HTMLInputElement>) {\n    const { value } = e.target\n    setQuery(value)\n    debounceSearch(value)\n  }\n\n  // Auto scroll the search container when navigating with arrow keys\n  useLayoutEffect(() => {\n    if (containerRef.current) {\n      const container = containerRef.current\n      const selectedItem = container.children[selected] as HTMLElement\n      const view = checkIsInView(selectedItem, container)\n      if (view === 'above') {\n        container.scrollTo({\n          top: selectedItem.offsetTop - container.offsetTop,\n          behavior: 'smooth'\n        })\n      } else if (view === 'below') {\n        container.scrollTo({\n          top: selectedItem.offsetTop + selectedItem.offsetHeight - container.offsetHeight,\n          behavior: 'smooth'\n        })\n      }\n    }\n  }, [selected])\n\n  function handleKeyDown(e: React.KeyboardEvent<HTMLInputElement>) {\n    if (e.key === 'Enter') {\n      // navigate to the selected result\n      if (data?.length && selected >= 0 && selected < data?.length) {\n        const uri = props.slugPrefix\n          ? `${props.slugPrefix}/${data[selected].slug}/`\n          : `${data[selected].slug}/`\n        e.preventDefault()\n        props.closeModal()\n        router.push(uri)\n      } else {\n        // trigger search\n        triggerSearch(inputRef.current?.value || '')\n        debounceSearch.cancel()\n      }\n    }\n\n    // navigate between the results\n    if (e.key === 'ArrowDown') {\n      e.preventDefault()\n      setSelected(prev => (!data || prev < data.length - 1 ? prev + 1 : prev))\n      // if before the arrow down, the selected item is the last item, set the selected to the first item\n      if (data?.length && data?.length > 0 && selected === data?.length - 1) {\n        setSelected(0)\n      }\n    }\n\n    if (e.key === 'ArrowUp') {\n      e.preventDefault()\n      setSelected(prev => (prev > 0 ? prev - 1 : prev))\n      // if before the arrow up, the selected item is the first item, set the selected to the last item\n      if (data?.length && data?.length > 0 && selected === 0) {\n        setSelected(data?.length - 1)\n      }\n    }\n  }\n\n  function handleMouseMoveCapture(index: number) {\n    setSelected(index)\n  }\n\n  function triggerSearch(value: string) {\n    setQueryToSearch(value)\n    setSelected(-1)\n  }\n\n  return (\n    <Transition appear={true} show={props.isOpen} as={Fragment}>\n      <Dialog as=\"div\" className={cn('relative z-50', props.className)} onClose={props.closeModal}>\n        <Transition.Child\n          as={Fragment}\n          enter=\"ease-out duration-300\"\n          enterFrom=\"opacity-0\"\n          enterTo=\"opacity-100\"\n          leave=\"ease-in duration-200\"\n          leaveFrom=\"opacity-100\"\n          leaveTo=\"opacity-0\"\n        >\n          <div className=\"bg-opacity/25 fixed inset-0 bg-black opacity-40\" />\n        </Transition.Child>\n\n        <div className=\"fixed inset-0 overflow-y-auto\">\n          <div className=\"flex min-h-full items-start justify-center p-4 pt-20 text-center\">\n            <Transition.Child\n              as={Fragment}\n              enter=\"ease-out duration-300\"\n              enterFrom=\"opacity-0 scale-95\"\n              enterTo=\"opacity-100 scale-100\"\n              leave=\"ease-in duration-300\"\n              leaveFrom=\"opacity-100 scale-100\"\n              leaveTo=\"opacity-0 scale-95\"\n            >\n              <Dialog.Panel\n                className={cn(\n                  'flex flex-col gap-0 w-full transform rounded-md divide-y',\n                  'md:max-w-[80vw] lg:max-w-[70vw] xl:max-w-[60vw] 2xl:max-w-[50vw] max-h-[80vh]',\n                  'bg-white text-left shadow-lg',\n                  'align-middle shadow-xl transition-all text-slate-800'\n                )}\n              >\n                {/* Search bar */}\n                <div className={cn('flex items-center gap-3 p-4')}>\n                  <div className={cn('grid place-items-center text-slate-500')}>\n                    {(data || error || get(data, '[0].isFake')) && !isLoading && (\n                      <FiSearch className=\"text-2xl\" />\n                    )}\n                    {isLoading && (\n                      <div className=\"animate-spin\">\n                        <AiOutlineLoading3Quarters className=\"text-2xl\" />\n                      </div>\n                    )}\n                  </div>\n                  <input\n                    ref={inputRef}\n                    className={cn(\n                      'peer h-full w-full text-ellipsis bg-transparent pr-2 outline-none',\n                      'm2it-hide-wscb'\n                    )}\n                    id=\"search\"\n                    type=\"search\"\n                    placeholder={props.placeholder || 'Search...'}\n                    autoComplete=\"off\"\n                    value={query}\n                    onChange={e => handleOnchangeInput(e)}\n                    onKeyDown={e => handleKeyDown(e)}\n                  />\n                  {query && (\n                    <button onClick={() => setQuery('')}>\n                      <IoCloseCircle className=\"h-5 w-5 text-slate-500\" />\n                    </button>\n                  )}\n                </div>\n\n                {/* Search results */}\n                {error && (\n                  <div className=\"p-4 text-center text-base\">\n                    {props.errorMessage || 'There was an error fetching the search results.'}\n                  </div>\n                )}\n                {data && !data?.[0]?.isFake && query && (\n                  <>\n                    {data.length === 0 && (\n                      <div className=\"p-4 text-center text-base\">\n                        {props.noResultsMessage || 'No results found.'}\n                      </div>\n                    )}\n                    {data.length > 0 && (\n                      <div className={cn('flex flex-col divide-y overflow-hidden')}>\n                        <div\n                          ref={containerRef}\n                          className={cn(\n                            'flex flex-col divide-y divide-slate-150 overflow-auto m2it-scrollbar'\n                          )}\n                        >\n                          {data.map((item, index) => {\n                            const uri = props.slugPrefix\n                              ? `/${props.slugPrefix}/${item.slug}/`\n                              : `/${item.slug}/`\n                            return (\n                              <Link\n                                onClick={props.closeModal}\n                                href={uri}\n                                key={item.id}\n                                className={cn('flex gap-3 py-4 px-4 w-full', {\n                                  'bg-gray-100': selected === index\n                                })}\n                                onMouseMoveCapture={() => handleMouseMoveCapture(index)}\n                              >\n                                <div className=\"mt-0.5\">\n                                  {!item.isBookPost && (\n                                    <IoDocumentTextOutline className=\"text-xl opacity-80\" />\n                                  )}\n                                  {item.isBookPost && (\n                                    <IoBookOutline className=\"text-xl opacity-80\" />\n                                  )}\n                                </div>\n                                <div className={cn('w-full flex flex-col text-slate-900 gap-1')}>\n                                  <div\n                                    className={cn(\n                                      'w-full text-base flex items-center justify-between'\n                                    )}\n                                  >\n                                    <div\n                                      className={cn({\n                                        'pr-4 pb-1 border-b border-dashed': item.textHighlighted\n                                      })}\n                                    >\n                                      {item.titleHighlighted && (\n                                        <span\n                                          dangerouslySetInnerHTML={{\n                                            __html: item.titleHighlighted\n                                          }}\n                                        ></span>\n                                      )}\n                                      {!item.titleHighlighted && <span>{item.title}</span>}\n                                    </div>\n                                    <div\n                                      className={cn({\n                                        visible: selected === index,\n                                        invisible: selected !== index\n                                      })}\n                                    >\n                                      <BsArrowReturnLeft className=\"text-lg opacity-70\" />\n                                    </div>\n                                  </div>\n                                  {item.textHighlighted && (\n                                    <div\n                                      className=\"text-sm opacity-80\"\n                                      dangerouslySetInnerHTML={{ __html: item.textHighlighted }}\n                                    ></div>\n                                  )}\n                                </div>\n                              </Link>\n                            )\n                          })}\n                        </div>\n                        {query && (\n                          <div className=\"p-3 pl-4 text-sm font-normal text-slate-500\">\n                            {props.foundResultsMessage?.split('{{count}}')[0] || 'Found '}\n                            <span className=\"font-semibold text-slate-900\">{data.length}</span>\n                            {props.foundResultsMessage?.split('{{count}}')[1] || ' results'}\n                          </div>\n                        )}\n                      </div>\n                    )}\n                  </>\n                )}\n              </Dialog.Panel>\n            </Transition.Child>\n          </div>\n        </div>\n      </Dialog>\n    </Transition>\n  )\n}\n\nconst fetcher = async (url: string, params: any) => {\n  if (params.query === '') return [{ isFake: true, isPublished: true }]\n  const headers: { [key: string]: string } = {\n    'Content-Type': 'application/json'\n  }\n  const res = await fetch(url, {\n    headers,\n    method: 'POST',\n    body: JSON.stringify(params),\n    mode: 'cors'\n  })\n  const json = await res.json()\n  return json\n}\n\nfunction checkIsInView(selectedEl: HTMLElement, containerEl: HTMLElement) {\n  const isOutBelow =\n    selectedEl.offsetTop + selectedEl.offsetHeight - containerEl.scrollTop >\n    containerEl.offsetHeight\n  const isOutAbove = selectedEl.offsetTop < containerEl.scrollTop\n  if (isOutAbove) {\n    return 'above'\n  } else if (isOutBelow) {\n    return 'below'\n  } else {\n    return 'in'\n  }\n}\n"],"mappings":"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","names":["Fragment"]}